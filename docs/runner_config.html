<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Configuring the Runners · tinyCI</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="&lt;p&gt;The most used runner is the &lt;code&gt;overlay-runner&lt;/code&gt;. While no runner really shares&lt;/p&gt;
"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Configuring the Runners · tinyCI"/><meta property="og:type" content="website"/><meta property="og:url" content="https://tinyci.org/"/><meta property="og:description" content="&lt;p&gt;The most used runner is the &lt;code&gt;overlay-runner&lt;/code&gt;. While no runner really shares&lt;/p&gt;
"/><meta property="og:image" content="https://tinyci.org/img/logo-mains.png"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="https://tinyci.org/img/logo-main.png"/><link rel="shortcut icon" href="/img/favicon.png"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/zenburn.min.css"/><script>
              (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
              (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
              m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
              })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

              ga('create', 'UA-139424969-1', 'auto');
              ga('send', 'pageview');
            </script><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script src="/js/scrollSpy.js"></script><link rel="stylesheet" href="/css/main.css"/><script src="/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/"><img class="logo" src="/img/logo-reverse-title.png" alt="tinyCI"/><h2 class="headerTitleWithLogo">tinyCI</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class=""><a href="/docs/intro" target="_self">Intro</a></li><li class="siteNavGroupActive"><a href="/docs/configuration" target="_self">Configuration Guide</a></li><li class=""><a href="/docs/api" target="_self">API</a></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="container docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><div class="hamburger-menu"><div class="line1"></div><div class="line2"></div><div class="line3"></div></div></div><h2><i>›</i><span>Configuration Guide</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle">Configuration Guide</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/configuration">Configuration Guide Introduction</a></li><li class="navListItem"><a class="navItem" href="/docs/oauth">tinyCI OAuth</a></li><li class="navListItem"><a class="navItem" href="/docs/auth_config">Configuring the Authentication Settings</a></li><li class="navListItem"><a class="navItem" href="/docs/tls_authentication">Using TLS Authentication for the Service Mesh</a></li><li class="navListItem"><a class="navItem" href="/docs/client_config">Client Configuration</a></li><li class="navListItem"><a class="navItem" href="/docs/service_config">Service Configuration</a></li><li class="navListItem"><a class="navItem" href="/docs/hooksvc_config">Configuration of the hooksvc</a></li><li class="navListItem navListItemActive"><a class="navItem" href="/docs/runner_config">Configuring the Runners</a></li><li class="navListItem"><a class="navItem" href="/docs/repository_config">Repository Configuration</a></li><li class="navListItem"><a class="navItem" href="/docs/repository_properties">Repository Configuration Properties</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              var headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                var el = event.target;
                while(el !== headings){
                  if (el.tagName === 'A') {
                    document.body.classList.remove('tocActive');
                    break;
                  } else{
                    el = el.parentNode;
                  }
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1 class="postHeaderTitle">Configuring the Runners</h1></header><article><div><span><p>The most used runner is the <code>overlay-runner</code>. While no runner really shares
common things like configuration, this document goes into how a runner talks to
the rest of the tinyCI ecosystem, as well as gives a baseline idea of how to
configure a runner.</p>
<h2><a class="anchor" aria-hidden="true" id="about-the-overlay-runner"></a><a href="#about-the-overlay-runner" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>About the overlay runner</h2>
<p>The overlay runner is a simple runner that:</p>
<ul>
<li>Runs one run at a time on a single host.</li>
<li>Clones your repo to a new repository, or refreshes an existing one.</li>
<li>Establishes an overlayfs mount atop the source code</li>
<li>Binds that top level overlayfs mount into docker</li>
<li>Runs the docker image with the provided command in the <code>task.yml</code> file (which
is assumed to run the actual test).</li>
<li>After the test is finished, will remove the upper overlayfs levels from disk.</li>
</ul>
<p>This pattern allows for maximum storage management potential, by:</p>
<ul>
<li>Minimizing host level filesystem damage (only the partition can be filled,
but no permanent damage can be done to the fs). The upper levels of the
overlayfs are removed after the test finishes, so any fs damage will be
contained there.</li>
<li>Limiting re-clones of the repository (repositories are always pristine and
kept), saving network bandwidth. Forks are kept with the parent as remotes.</li>
<li>Use (and re-use on fresh runs) of docker images also saves bandwidth
downloading images.</li>
</ul>
<h2><a class="anchor" aria-hidden="true" id="architecture-for-runner-installation"></a><a href="#architecture-for-runner-installation" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Architecture for runner installation</h2>
<p>The overlay runner occupies a VM for CI tasks; what the VM looks like is up to
the administrator, but it is strongly recommended that every VM for a given
queue is uniform as much as can be managed. <strong>Each runner VM must have a
working docker installation on it</strong>.</p>
<p>The overlay runner requires <strong>root access</strong> to establish the overlay mounts. In
the future this will not be a necessary limitation.</p>
<p>Each runner will talk to three microservices:</p>
<ul>
<li><code>queuesvc</code>: what hands out the items to run.</li>
<li><code>logsvc</code>: to emit syslog-like logs.</li>
<li><code>assetsvc</code>: to emit the logs from the CI run.</li>
</ul>
<h2><a class="anchor" aria-hidden="true" id="configuring-the-runner"></a><a href="#configuring-the-runner" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Configuring the runner</h2>
<p>The runner uses a YAML configuration file that looks very similar to other
config files within the tinyCI ecosystem. It consists of a list of clients
(with optional TLS settings) and a named queue:</p>
<pre><code class="hljs css language-yaml"><span class="hljs-attr">queue:</span> <span class="hljs-string">'default'</span>
<span class="hljs-attr">clients:</span>
<span class="hljs-attr">  tls:</span>
<span class="hljs-attr">    ca:</span> <span class="hljs-string">/var/tinyci/ca/rootCA.pem</span>
<span class="hljs-attr">    cert:</span> <span class="hljs-string">/var/tinyci/ca/tinyci-client.pem</span>
<span class="hljs-attr">    key:</span> <span class="hljs-string">/var/tinyci/ca/tinyci-client.key</span>
<span class="hljs-attr">  logsvc:</span> <span class="hljs-string">'machine-1.local:6005'</span>
<span class="hljs-attr">  queuesvc:</span> <span class="hljs-string">'machine-1.local:6001'</span>
<span class="hljs-attr">  assetsvc:</span> <span class="hljs-string">'machine-1.local:6002'</span>
</code></pre>
<p>This configures the microservice clients for the runner (with optional TLS
data), and sets up the <a href="/docs/queues">queue</a> that the runner will use to receive
data from.</p>
<h2><a class="anchor" aria-hidden="true" id="managing-the-overlay-runner-service"></a><a href="#managing-the-overlay-runner-service" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Managing the overlay runner service</h2>
<p>The easiest way to do this is with <code>systemd</code>. Check out the following unit file
suitable for running <code>overlay-runner</code>.</p>
<pre><code class="hljs css language-ini"><span class="hljs-section">[Unit]</span>
<span class="hljs-attr">Description</span>=overlay-runner
<span class="hljs-attr">After</span>=network.target
<span class="hljs-attr">StartLimitIntervalSec</span>=<span class="hljs-number">0</span>
<span class="hljs-section">
[Service]</span>
<span class="hljs-attr">Type</span>=simple
<span class="hljs-attr">Restart</span>=always
<span class="hljs-attr">RestartSec</span>=<span class="hljs-number">1</span>
<span class="hljs-attr">User</span>=root
<span class="hljs-attr">ExecStart</span>=/var/tinyci/bin/overlay-runner -c /path/to/config/file.yml
<span class="hljs-attr">WorkingDirectory</span>=/var/tinyci/bin/
<span class="hljs-section">
[Install]</span>
<span class="hljs-attr">WantedBy</span>=multi-user.target
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="canceling-runs"></a><a href="#canceling-runs" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Canceling runs</h2>
<p>Upon cancel, overlay runner will stop the run immediately and clean up.
Sometimes, due to various circumstances the run will not get canceled in the
UI. <code>cancelbot</code> is here to assist with that. Running in <code>cron</code>, it can be used
to clean up any runs that clearly aren't running anymore (to avoid noise in the
UI).</p>
<h2><a class="anchor" aria-hidden="true" id="signal-handling"></a><a href="#signal-handling" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Signal Handling</h2>
<p>Signals sent to the overlay runner will manage the underlying run the runner is
working on (if any). The follow signals affect runs in the following ways.</p>
<ul>
<li>SIGTERM, SIGINT: cancel running job</li>
</ul>
</span></div></article></div><div class="docs-prevnext"><a class="docs-prev button" href="/docs/hooksvc_config"><span class="arrow-prev">← </span><span>Configuration of the hooksvc</span></a><a class="docs-next button" href="/docs/repository_config"><span>Repository Configuration</span><span class="arrow-next"> →</span></a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#about-the-overlay-runner">About the overlay runner</a></li><li><a href="#architecture-for-runner-installation">Architecture for runner installation</a></li><li><a href="#configuring-the-runner">Configuring the runner</a></li><li><a href="#managing-the-overlay-runner-service">Managing the overlay runner service</a></li><li><a href="#canceling-runs">Canceling runs</a></li><li><a href="#signal-handling">Signal Handling</a></li></ul></nav></div><footer class="nav-footer" id="footer"><section class="sitemap"><a href="/" class="nav-home"><img src="/img/logo-reverse.png" alt="tinyCI" width="66" height="58"/></a><div><h5>Docs</h5><a href="/docs/en/intro.html">Getting Started</a><a href="/docs/en/installation.html">Installation Guide</a><a href="/docs/en/configuration.html">Configuration Guide</a><a href="/docs/en/api.html">API Reference</a></div><div><h5>Community</h5><a target="_blank" href="https://discord.gg/Y5tpxhU">Project Chat</a><a href="https://twitter.com/tinyci2" target="_blank" rel="noreferrer noopener">tinyCI Twitter</a></div><div><h5>More</h5><a class="github-button" href="https://github.com/tinyci/tinyci" data-icon="octicon-star" data-count-href="https://github.com/tinyci/tinyci/stargazers" data-show-count="true" data-count-aria-label="# stargazers on GitHub" aria-label="Star this project on GitHub">Star us on Github</a></div></section><section class="copyright">Copyright © 2019 Erik Hollensbe</section></footer></div></body></html>